document.addEventListener("DOMContentLoaded",function(){
  var token=localStorage.getItem("token");
  if(!token){window.location.href="/login.html";return;}
  var qs=new URLSearchParams(location.search);
  var articleId=Number(qs.get("id"));
  var titleEl=document.getElementById("title");
  var metaEl=document.getElementById("meta");
  var contentEl=document.getElementById("content");
  var likeBtn=document.getElementById("like-btn");
  var likeCountEl=document.getElementById("like-count");
  var errorEl=document.getElementById("error");
  var commentList=document.getElementById("comment-list");
  var editorInput=document.getElementById("comment-input");
  var editorSubmit=document.getElementById("comment-submit");
  var editorError=document.getElementById("comment-error");
  var currentUserId=null;
  if(!articleId){errorEl.textContent="缺少文章ID";return;}
  async function getJSON(url,options){var res=await fetch(url,options||{});var data=await res.json();if(res.ok&&data&&data.code===200){return data.data}else{var msg=(data&&data.msg)||(data&&data.message)||\"请求失败\";throw new Error(msg)}}
  async function loadUser(){try{var data=await getJSON(\"/api/user/getinfo\",{headers:{Authorization:token}});currentUserId=data&&data.id}catch(e){}}
  async function loadDetail(){try{var data=await getJSON(\"/api/article/view?article_id=\"+articleId,{method:\"POST\",headers:{Authorization:token}});titleEl.textContent=data.title||\"无标题\";var author=(data.username?\"作者：\"+data.username:\"\");var created=(data.created_at?\" | 时间：\"+data.created_at:\"\");var view=(data.view_count!=null?\" | 浏览：\"+data.view_count:\"\");metaEl.textContent=author+created+view;var html=data.content||\"\";contentEl.innerHTML=html}catch(e){errorEl.textContent=e.message}}
  async function loadLikeCount(){try{var n=await getJSON(\"/api/article/getlike?article_id=\"+articleId,{headers:{Authorization:token}});likeCountEl.textContent=n}catch(e){}}
  async function checkLiked(){try{var list=await getJSON(\"/api/user/mylike\",{headers:{Authorization:token}});var liked=list&&list.some(function(a){return a.id===articleId});likeBtn.classList.toggle(\"active\",liked);return liked}catch(e){return false}}
  async function toggleLike(){var liked=likeBtn.classList.contains(\"active\");try{if(liked){await getJSON(\"/api/article/like?article_id=\"+articleId,{method:\"DELETE\",headers:{Authorization:token}})}else{await getJSON(\"/api/article/like?article_id=\"+articleId,{method:\"POST\",headers:{Authorization:token}})}await loadLikeCount();await checkLiked()}catch(e){errorEl.textContent=e.message}}
  async function loadParents(){try{var list=await getJSON(\"/api/comment/parent?article_id=\"+articleId,{headers:{Authorization:token}});renderParents(list||[])}catch(e){errorEl.textContent=e.message}}
  function renderParents(items){commentList.innerHTML=\"\";if(!items||items.length===0){commentList.innerHTML=\"<div class=\\\"comment\\\">暂无评论</div>\";return}items.forEach(function(c){var box=document.createElement(\"div\");box.className=\"comment\";var header=document.createElement(\"div\");header.className=\"comment-header\";header.textContent=(c.username||\"匿名\")+\" • \"+(c.create_at||\"\");var content=document.createElement(\"div\");content.className=\"comment-content\";content.textContent=c.content||\"\";var actions=document.createElement(\"div\");actions.className=\"comment-actions\";var viewBtn=document.createElement(\"button\");viewBtn.className=\"btn secondary\";viewBtn.textContent=\"查看回复\";var replyBtn=document.createElement(\"button\");replyBtn.className=\"btn secondary\";replyBtn.textContent=\"回复\";actions.appendChild(viewBtn);actions.appendChild(replyBtn);if(currentUserId&&c.user_id===currentUserId){var delBtn=document.createElement(\"button\");delBtn.className=\"btn secondary\";delBtn.textContent=\"删除\";delBtn.addEventListener(\"click\",function(){deleteComment(c.id)});actions.appendChild(delBtn)}var children=document.createElement(\"div\");children.className=\"comment-children\";box.appendChild(header);box.appendChild(content);box.appendChild(actions);box.appendChild(children);commentList.appendChild(box);viewBtn.addEventListener(\"click\",function(){loadChildren(c.id,children)});replyBtn.addEventListener(\"click\",function(){spawnReplyEditor(c.id,children)})})}
  async function loadChildren(parentId,container){try{var list=await getJSON(\"/api/comment/son?parent_comment_id=\"+parentId,{headers:{Authorization:token}});container.innerHTML=\"\";(list||[]).forEach(function(c){var child=document.createElement(\"div\");child.className=\"comment\";var header=document.createElement(\"div\");header.className=\"comment-header\";header.textContent=(c.username||\"匿名\")+\" • \"+(c.create_at||\"\");var content=document.createElement(\"div\");content.className=\"comment-content\";content.textContent=c.content||\"\";var actions=document.createElement(\"div\");actions.className=\"comment-actions\";var replyBtn=document.createElement(\"button\");replyBtn.className=\"btn secondary\";replyBtn.textContent=\"回复\";actions.appendChild(replyBtn);if(currentUserId&&c.user_id===currentUserId){var delBtn=document.createElement(\"button\");delBtn.className=\"btn secondary\";delBtn.textContent=\"删除\";delBtn.addEventListener(\"click\",function(){deleteComment(c.id)});actions.appendChild(delBtn)}child.appendChild(header);child.appendChild(content);child.appendChild(actions);container.appendChild(child);replyBtn.addEventListener(\"click\",function(){spawnReplyEditor(c.id,container)})})}catch(e){container.innerHTML=\"加载失败\"}}
  function spawnReplyEditor(parentId,container){var wrap=document.createElement(\"div\");wrap.className=\"comment-editor\";var input=document.createElement(\"textarea\");var submit=document.createElement(\"button\");submit.className=\"btn primary\";submit.textContent=\"提交回复\";var err=document.createElement(\"div\");err.className=\"error\";wrap.appendChild(input);wrap.appendChild(submit);wrap.appendChild(err);container.prepend(wrap);submit.addEventListener(\"click\",async function(){var text=input.value.trim();if(!text){err.textContent=\"内容不能为空\";return}try{await publishComment(text,parentId);await loadChildren(parentId,container)}catch(e){err.textContent=e.message}})}
  async function publishComment(text,parentId){var body={article_id:articleId,content:text,parent_comment_id:parentId||null};var res=await fetch(\"/api/comment/add\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:token},body:JSON.stringify(body)});var data=await res.json();if(!(res.ok&&data&&data.code===200)){var msg=(data&&data.msg)||(data&&data.message)||\"发表评论失败\";throw new Error(msg)}}
  async function deleteComment(id){try{await getJSON(\"/api/comment/delete?comment_id=\"+id,{method:\"DELETE\",headers:{Authorization:token}});await loadParents()}catch(e){errorEl.textContent=e.message}}
  editorSubmit.addEventListener(\"click\",async function(){var text=editorInput.value.trim();if(!text){editorError.textContent=\"内容不能为空\";return}try{await publishComment(text,null);editorInput.value=\"\";editorError.textContent=\"\";await loadParents()}catch(e){editorError.textContent=e.message}});
  likeBtn.addEventListener(\"click\",toggleLike);
  document.getElementById(\"link-logout\").addEventListener(\"click\",async function(e){e.preventDefault();try{var r=await fetch(\"/api/logout\",{method:\"DELETE\",headers:{Authorization:token}});localStorage.removeItem(\"token\");window.location.href=\"/login.html\"}catch(err){localStorage.removeItem(\"token\");window.location.href=\"/login.html\"}});
  (async function(){await loadUser();await loadDetail();await loadLikeCount();await checkLiked();await loadParents();})();
});
